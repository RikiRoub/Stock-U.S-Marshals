<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Profil Utilisateur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f7f9fc; }
h1 { text-align:center; margin-bottom:20px; }
form { max-width:500px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
label { display:block; margin-top:10px; font-weight:bold; }
input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
button { margin-top:15px; padding:10px 15px; background:#4D96FF; color:white; border:none; border-radius:5px; cursor:pointer; }
button:hover { background:#357AE8; }
#msg { text-align:center; margin-top:15px; }
#profile-pic { display:block; margin:10px auto; width:120px; height:120px; border-radius:50%; object-fit:cover; border:2px solid #4D96FF; }
#remove-btn { background:#E63946; }
#remove-btn:hover { background:#C62828; }
.profile-card { max-width:500px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; }
.profile-card img { width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #4D96FF; margin-bottom:10px; }
.profile-card h2 { margin:10px 0 5px; }
.profile-card p { margin:5px 0; }
</style>
</head>
<body>

<h1>Mon Profil</h1>
<p id="welcome-msg"></p>

<img id="profile-pic" src="https://via.placeholder.com/120" alt="Photo de profil">

<form id="profile-form">
  <label for="profileImage">Photo de Profil</label>
  <input type="file" id="profileImage" accept="image/*">

  <button type="button" id="remove-btn">Supprimer la photo</button>

  <label for="fullName">Nom Complet</label>
  <input type="text" id="fullName" placeholder="Votre nom complet" required>

  <label for="phone">Téléphone</label>
  <input type="text" id="phone" placeholder="Votre numéro de téléphone" required>

  <label for="matricule">Matricule</label>
  <input type="text" id="matricule" placeholder="Votre matricule" required>

  <label for="rib">RIB</label>
  <input type="text" id="rib" placeholder="Votre RIB" required>

  <button type="submit">Enregistrer</button>
</form>

<p id="msg"></p>

<!-- Carte récap profil -->
<div class="profile-card" id="profile-card" style="display:none;">
  <img id="card-photo" src="https://via.placeholder.com/120" alt="Photo">
  <h2 id="card-name">Nom complet</h2>
  <p><i class="bi bi-envelope"></i> <span id="card-email"></span></p>
  <p><i class="bi bi-telephone"></i> <span id="card-phone"></span></p>
  <p><i class="bi bi-person-badge"></i> Matricule : <span id="card-matricule"></span></p>
  <p><i class="bi bi-bank"></i> RIB : <span id="card-rib"></span></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0.appspot.com",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const form = document.getElementById("profile-form");
const msg = document.getElementById("msg");
const profilePic = document.getElementById("profile-pic");
const removeBtn = document.getElementById("remove-btn");
const profileCard = document.getElementById("profile-card");

let uploadedImageFile = null;
const defaultPic = "https://via.placeholder.com/120";
let currentUser = null;

// Preview image
document.getElementById("profileImage").addEventListener("change", (e) => {
  uploadedImageFile = e.target.files[0];
  if (uploadedImageFile) {
    profilePic.src = URL.createObjectURL(uploadedImageFile);
  }
});

// Supprimer la photo
removeBtn.addEventListener("click", async () => {
  if (!currentUser) return;
  try {
    const imageRef = ref(storage, `profilePictures/${currentUser.uid}`);
    await deleteObject(imageRef).catch(() => {});
    await setDoc(doc(db, "profiles", currentUser.uid), { photoURL: "" }, { merge: true });
    profilePic.src = defaultPic;
    updateCard({ photoURL: "" });
    msg.innerText = "✅ Photo supprimée.";
    msg.style.color = "green";
  } catch (error) {
    msg.innerText = "❌ Erreur suppression : " + error.message;
    msg.style.color = "red";
  }
});

// Auth
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    document.body.innerHTML = "<h2>Accès refusé. Veuillez vous connecter.</h2>";
    return;
  }
  currentUser = user;
  document.getElementById("welcome-msg").innerText = `Bienvenue ${user.email}`;
  const userDocRef = doc(db, "profiles", user.uid);
  const userDocSnap = await getDoc(userDocRef);

  if (userDocSnap.exists()) {
    const data = userDocSnap.data();
    document.getElementById("fullName").value = data.fullName || "";
    document.getElementById("phone").value = data.phone || "";
    document.getElementById("matricule").value = data.matricule || "";
    document.getElementById("rib").value = data.rib || "";
    profilePic.src = data.photoURL || defaultPic;
    updateCard(data);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      let photoURL = profilePic.src;
      if (uploadedImageFile) {
        const imageRef = ref(storage, `profilePictures/${user.uid}`);
        await uploadBytes(imageRef, uploadedImageFile);
        photoURL = await getDownloadURL(imageRef);
      }

      const profileData = {
        fullName: document.getElementById("fullName").value,
        phone: document.getElementById("phone").value,
        matricule: document.getElementById("matricule").value,
        rib: document.getElementById("rib").value,
        email: user.email,
        photoURL
      };

      await setDoc(userDocRef, profileData);
      updateCard(profileData);
      msg.innerText = "✅ Profil mis à jour !";
      msg.style.color = "green";
    } catch (error) {
      msg.innerText = "❌ Erreur : " + error.message;
      msg.style.color = "red";
    }
  });
});

// Mettre à jour la carte
function updateCard(data) {
  profileCard.style.display = "block";
  document.getElementById("card-photo").src = data.photoURL || defaultPic;
  document.getElementById("card-name").innerText = data.fullName || "Nom non défini";
  document.getElementById("card-email").innerText = data.email || "";
  document.getElementById("card-phone").innerText = data.phone || "";
  document.getElementById("card-matricule").innerText = data.matricule || "";
  document.getElementById("card-rib").innerText = data.rib || "";
}
</script>

</body>
</html>
