<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Agent</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; background:#f7f9fc; }
h1 { margin-bottom: 20px; text-align:center; }
#welcome-msg { text-align:center; margin-bottom:20px; font-weight:bold; }

.tab { display:flex; justify-content: space-around; margin-bottom:10px; }
.tab button { flex:1; padding:10px 0; border:none; cursor:pointer; color:white; font-weight:bold; transition:0.3s; display:flex; justify-content:center; align-items:center; gap:5px; border-radius:5px 5px 0 0; }
.tab button.active { box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.tabcontent { display:none; padding:20px; background:white; border-radius:0 5px 5px 5px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
form { margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
input, button { padding:8px; border:1px solid #ccc; border-radius:5px; }
button[type="submit"] { background:#4CAF50; color:white; border:none; cursor:pointer; transition:0.3s; }
button[type="submit"]:hover { background:#45a049; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f2f2f2; }
button.delete-btn { background:red; color:white; border:none; border-radius:3px; cursor:pointer; padding:5px 8px; }
</style>
</head>
<body>

<h1>Dashboard Agent</h1>
<p id="welcome-msg"></p>

<div class="tab">
  <button class="tablinks" data-role="ftf" style="background:#FF6B6B;"><i class="bi bi-people-fill"></i> FTF</button>
  <button class="tablinks" data-role="jsd" style="background:#4D96FF;"><i class="bi bi-shield-fill"></i> JSD</button>
  <button class="tablinks" data-role="srt" style="background:#FFD93D;"><i class="bi bi-clock-fill"></i> SRT</button>
  <button class="tablinks" data-role="afd" style="background:#6BCB77;"><i class="bi bi-truck"></i> AFD</button>
  <button class="tablinks" data-role="com" style="background:#FF6BDB;"><i class="bi bi-camera-video-fill"></i> COM</button>
  <button class="tablinks" data-role="hc" style="background:#845EC2;"><i class="bi bi-house-fill"></i> HC</button>
</div>

<!-- Sections onglets -->
<div id="ftf" class="tabcontent">
  <h2>FTF - Reward</h2>
  <form id="ftf-form">
      <input type="number" id="ftf-reward" placeholder="Reward $" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="ftf-total-prime">0</span></p>
  <table id="ftf-table"><thead><tr><th>Reward</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="jsd" class="tabcontent">
  <h2>JSD - Audience Protection</h2>
  <form id="jsd-form">
      <input type="number" id="jsd-hours" placeholder="Durée (heures)" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="jsd-total-prime">0</span></p>
  <table id="jsd-table"><thead><tr><th>Heures</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="srt" class="tabcontent">
  <h2>SRT - Prime</h2>
  <form id="srt-form">
      <input type="number" id="srt-hours" placeholder="Nombre d'heures" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="srt-total-prime">0</span></p>
  <table id="srt-table"><thead><tr><th>Heures</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="afd" class="tabcontent">
  <h2>AFD - Convois</h2>
  <form id="afd-form">
      <input type="number" id="afd-convois" placeholder="Nombre de convois" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="afd-total-prime">0</span></p>
  <table id="afd-table"><thead><tr><th>Convois</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="com" class="tabcontent">
  <h2>COM - Publications / Vidéos</h2>
  <form id="com-form">
      <input type="number" id="com-publications" placeholder="Publications" required>
      <input type="number" id="com-videos" placeholder="Vidéos" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="com-total-prime">0</span></p>
  <table id="com-table"><thead><tr><th>Publications</th><th>Vidéos</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="hc" class="tabcontent">
  <h2>HC - Prime</h2>
  <form id="hc-form">
      <input type="number" id="hc-hours" placeholder="Nombre d'heures" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="hc-total-prime">0</span></p>
  <table id="hc-table"><thead><tr><th>Heures</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userActivities = { ftf: [], jsd: [], srt: [], afd: [], com: [], hc: [] };
const primeFuncs = { ftf: a=>a.reward*0.065, jsd: a=>a.hours*35, srt: a=>a.hours*23, afd: a=>a.convois*20, com: a=>a.publications*10+a.videos*15, hc: a=>a.hours*30 };

const tablinks = document.querySelectorAll(".tablinks");
tablinks.forEach(btn => btn.addEventListener("click", ()=>{ openTab(btn.dataset.role); }));
function openTab(role){
    document.querySelectorAll(".tabcontent").forEach(t=>t.style.display="none");
    document.getElementById(role).style.display="block";
    tablinks.forEach(b=>b.classList.remove("active"));
    document.querySelector(`.tablinks[data-role="${role}"]`).classList.add("active");
}
openTab("ftf"); 

function setupRole(role, calcPrimeFunc){
    const form = document.getElementById(`${role}-form`);
    const tbody = document.querySelector(`#${role}-table tbody`);
    const totalSpan = document.getElementById(`${role}-total-prime`);
    function render(){
        tbody.innerHTML="";
        let total=0;
        userActivities[role].forEach((act,i)=>{
            const prime = calcPrimeFunc(act);
            total += prime;
            const row = document.createElement("tr");
            let cols="";
            if(role==="ftf") cols=`<td>${act.reward}</td><td>${prime.toFixed(2)}</td>`;
            else if(role==="jsd"||role==="srt"||role==="hc") cols=`<td>${act.hours}</td><td>${prime.toFixed(2)}</td>`;
            else if(role==="afd") cols=`<td>${act.convois}</td><td>${prime.toFixed(2)}</td>`;
            else if(role==="com") cols=`<td>${act.publications}</td><td>${act.videos}</td><td>${prime.toFixed(2)}</td>`;
            row.innerHTML = cols+`<td><button class="delete-btn" data-index="${i}">Supprimer</button></td>`;
            tbody.appendChild(row);
        });
        totalSpan.innerText=total.toFixed(2);
        tbody.querySelectorAll(".delete-btn").forEach(btn=>btn.addEventListener("click", async e=>{
            const idx=parseInt(e.target.dataset.index);
            userActivities[role].splice(idx,1);
            await setDoc(doc(db,"userActivities",auth.currentUser.uid),userActivities,{merge:true});
            render();
        }));
    }
    form.addEventListener("submit", async e=>{
        e.preventDefault();
        const newAct={};
        if(role==="ftf") newAct.reward=parseFloat(document.getElementById("ftf-reward").value);
        else if(role==="jsd") newAct.hours=parseFloat(document.getElementById("jsd-hours").value);
        else if(role==="srt") newAct.hours=parseFloat(document.getElementById("srt-hours").value);
        else if(role==="afd") newAct.convois=parseInt(document.getElementById("afd-convois").value);
        else if(role==="com"){ newAct.publications=parseInt(document.getElementById("com-publications").value); newAct.videos=parseInt(document.getElementById("com-videos").value); }
        else if(role==="hc") newAct.hours=parseFloat(document.getElementById("hc-hours").value);
        userActivities[role].push(newAct);
        await setDoc(doc(db,"userActivities",auth.currentUser.uid),userActivities,{merge:true});
        render();
        form.reset();
    });
    return render;
}

const renderFTF = setupRole("ftf", primeFuncs.ftf);
const renderJSD = setupRole("jsd", primeFuncs.jsd);
const renderSRT = setupRole("srt", primeFuncs.srt);
const renderAFD = setupRole("afd", primeFuncs.afd);
const renderCOM = setupRole("com", primeFuncs.com);
const renderHC = setupRole("hc", primeFuncs.hc);

onAuthStateChanged(auth,user=>{
    if(!user) return;
    document.getElementById("welcome-msg").innerText=`Bienvenue ${user.email}`;
    getDoc(doc(db,"userActivities",user.uid)).then(docSnap=>{ if(docSnap.exists()) userActivities=docSnap.data();
        renderFTF(); renderJSD(); renderSRT(); renderAFD(); renderCOM(); renderHC();
    });
});
</script>

</body>
</html>
