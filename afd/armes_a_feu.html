<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion Armes à Feu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        form { margin-bottom: 20px; }
        input, select { padding: 5px; margin: 5px; }
        button { padding: 5px 10px; cursor: pointer; }
        @media (max-width: 600px) {
            table, th, td { font-size: 14px; }
            input, select, button { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Config Firebase (à adapter avec ton projet)
const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0.appspot.com",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77",
    measurementId: "G-LX4G4FY0ZP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

// Vérification du rôle AFD
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }
    const docRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) {
        alert("Utilisateur introuvable");
        window.location.href = "login.html";
        return;
    }
     const roles = docSnap.data().roles || [];
      if (!roles.includes("AFD")) {
        alert("Accès interdit");
        window.location.href = "index.html";
    }
});
</script>

    <h1>Stock Armes à Feu</h1>

    <!-- Bouton pour retourner à l'accueil -->
    <button onclick="window.location.href='/Stock-U.S-Marshals/index.html'" style="margin-bottom: 20px; padding: 5px 10px; cursor: pointer;">
        Accueil
    </button>

    <form id="form-stock">
        <input type="text" id="nom" placeholder="ETIQUETTE ARMES" required>
        <input type="text" id="numeroSerie" placeholder="NUMÉRO DE SÉRIE" required>
        <input type="text" id="date" placeholder="DATE D'ENTRE SAISIES" required>
        <input type="text" id="lieu" placeholder="LIEU DE SAISIE" required>
        <input type="text" id="provenance" placeholder="PROVENANCE PRÉSUMÉE" required>

        <select id="statut" required>
            <option value="">STATUT ACTUEL</option>
            <option>Disponible</option>
            <option>En Maintenance</option>
            <option>Confisqué</option>
            <option>En Cours de Saisie</option>
        </select>

        <input type="text" id="affaires" placeholder="AFFAIRS LIÉE" required>

        <select id="typeArmes" required>
            <option value="">TYPE D'ARMES</option>
            <option>Fusil</option>
            <option>Pistolet</option>
            <option>Mitrailleuse</option>
        </select>

        <select id="calibre" required>
            <option value="">CALIBRE</option>
            <option>9mm</option>
            <option>7.62mm</option>
            <option>.45 ACP</option>
        </select>

        <select id="stockage" required>
            <option value="">STOCKAGE</option>
            <option>Armoire</option>
            <option>Box sécurisé</option>
            <option>Magasin</option>
        </select>

        <button type="submit">Ajouter</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>N° DE SAISIES</th>
                <th>ETIQUETTE ARMES</th>
                <th>NUMÉRO DE SÉRIE</th>
                <th>TYPE D'ARMES</th>
                <th>CALIBRE</th>
                <th>DATE D'ENTRE SAISIES</th>
                <th>LIEU DE SAISIE</th>
                <th>PROVENANCE PRÉSUMÉE</th>
                <th>STATUT ACTUEL</th>
                <th>AFFAIRS LIÉE</th>
                <th>STOCKAGE</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="tableau-stock"></tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
            authDomain: "gestion-stock-d63d0.firebaseapp.com",
            projectId: "gestion-stock-d63d0",
            storageBucket: "gestion-stock-d63d0.appspot.com",
            messagingSenderId: "865227689174",
            appId: "1:865227689174:web:213e7f6e44f183c6928d77",
            measurementId: "G-LX4G4FY0ZP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const stockCollection = collection(db, "armes_a_feu");

        let compteur = 1;

        async function ajouterArticle(article) {
            try {
                await addDoc(stockCollection, article);
            } catch (error) {
                console.error("Erreur lors de l'ajout :", error);
            }
        }

        // Fonction supprimer accessible depuis le HTML
        async function supprimer(id) {
            if (!confirm("Voulez-vous vraiment supprimer cet article ?")) return;
            try {
                await deleteDoc(doc(db, "armes_a_feu", id));
            } catch (error) {
                console.error("Erreur lors de la suppression :", error);
            }
        }
        window.supprimer = supprimer;

        async function modifierSelect(id, champ, valeur) {
            try {
                const docRef = doc(db, "armes_a_feu", id);
                await updateDoc(docRef, { [champ]: valeur });
            } catch (error) {
                console.error("Erreur lors de la modification :", error);
            }
        }
        window.modifierSelect = modifierSelect;

        function afficherStock() {
            const tbody = document.getElementById("tableau-stock");
            onSnapshot(stockCollection, (snapshot) => {
                tbody.innerHTML = "";
                compteur = 1;
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const numeroSaisie = "AAF" + compteur.toString().padStart(6, "0");
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${numeroSaisie}</td>
                        <td>${item.nom}</td>
                        <td>${item.numeroSerie}</td>
                        <td>
                            <select onchange="modifierSelect('${docSnap.id}','typeArmes', this.value)">
                                <option ${item.typeArmes === "Fusil" ? "selected" : ""}>Fusil</option>
                                <option ${item.typeArmes === "Pistolet" ? "selected" : ""}>Pistolet</option>
                                <option ${item.typeArmes === "Mitrailleuse" ? "selected" : ""}>Mitrailleuse</option>
                            </select>
                        </td>
                        <td>
                            <select onchange="modifierSelect('${docSnap.id}','calibre', this.value)">
                                <option ${item.calibre === "9mm" ? "selected" : ""}>9mm</option>
                                <option ${item.calibre === "7.62mm" ? "selected" : ""}>7.62mm</option>
                                <option ${item.calibre === ".45 ACP" ? "selected" : ""}>.45 ACP</option>
                            </select>
                        </td>
                        <td>${item.date}</td>
                        <td>${item.lieu}</td>
                        <td>${item.provenance}</td>
                        <td>
                            <select onchange="modifierSelect('${docSnap.id}','statut', this.value)">
                                <option ${item.statut === "Disponible" ? "selected" : ""}>Disponible</option>
                                <option ${item.statut === "En Maintenance" ? "selected" : ""}>En Maintenance</option>
                                <option ${item.statut === "Confisqué" ? "selected" : ""}>Confisqué</option>
                                <option ${item.statut === "En Cours de Saisie" ? "selected" : ""}>En Cours de Saisie</option>
                            </select>
                        </td>
                        <td>${item.affaires}</td>
                        <td>
                            <select onchange="modifierSelect('${docSnap.id}','stockage', this.value)">
                                <option ${item.stockage === "Armoire" ? "selected" : ""}>Armoire</option>
                                <option ${item.stockage === "Box sécurisé" ? "selected" : ""}>Box sécurisé</option>
                                <option ${item.stockage === "Magasin" ? "selected" : ""}>Magasin</option>
                            </select>
                        </td>
                        <td><button onclick="supprimer('${docSnap.id}')">Supprimer</button></td>
                    `;
                    tbody.appendChild(row);
                    compteur++;
                });
            });
        }

        document.getElementById("form-stock").addEventListener("submit", async function(e) {
            e.preventDefault();

            const article = {
                nom: document.getElementById("nom").value.trim(),
                numeroSerie: document.getElementById("numeroSerie").value.trim(),
                date: document.getElementById("date").value.trim(),
                lieu: document.getElementById("lieu").value.trim(),
                provenance: document.getElementById("provenance").value.trim(),
                statut: document.getElementById("statut").value,
                affaires: document.getElementById("affaires").value.trim(),
                typeArmes: document.getElementById("typeArmes").value,
                calibre: document.getElementById("calibre").value,
                stockage: document.getElementById("stockage").value
            };

            await ajouterArticle(article);
            this.reset();
        });

        afficherStock();
    </script>
</body>
</html>
