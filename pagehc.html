<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Panel HC</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

  <div class="max-w-4xl mx-auto bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-4">
      <div id="whoami"></div>
      <button id="logoutBtn" class="bg-red-500 text-white p-1 px-3 rounded">Déconnexion</button>
    </div>

    <h2 class="text-xl font-bold mb-4">Récapitulatif des primes</h2>
    <table class="w-full border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Agent</th>
          <th class="border p-2">Total ($)</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <button id="resetBtn" class="bg-orange-500 text-white p-2 mt-4 rounded">Reset toutes les primes</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
  authDomain: "gestion-stock-d63d0.firebaseapp.com",
  projectId: "gestion-stock-d63d0",
  storageBucket: "gestion-stock-d63d0.firebasestorage.app",
  messagingSenderId: "865227689174",
  appId: "1:865227689174:web:213e7f6e44f183c6928d77"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function $(id) { return document.querySelector(id); }

async function currentUserRoles() {
  const u = auth.currentUser;
  if (!u) return [];
  const snap = await getDoc(doc(db, "users", u.uid));
  return snap.exists() ? (snap.data().roles || []) : [];
}

$("#logoutBtn").onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  if (!user) location.href = "index.html";
  const roles = await currentUserRoles();
  if (!roles.includes("hc")) {
    alert("Accès réservé HC");
    location.href = "index.html";
    return;
  }
  $("#whoami").textContent = `${user.displayName || user.email} – HC`;
  await loadTable();
});

async function loadTable() {
  const snap = await getDocs(collection(db, "entries"));
  const data = {};
  snap.forEach(docu => {
    const d = docu.data();
    if (!data[d.uid]) data[d.uid] = { name: d.displayName, total: 0 };
    data[d.uid].total += d.total;
  });

  $("#tableBody").innerHTML = "";
  for (let uid in data) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="border p-2">${data[uid].name}</td><td class="border p-2">${data[uid].total.toFixed(2)}</td>`;
    $("#tableBody").appendChild(tr);
  }
}

$("#resetBtn").onclick = async () => {
  if (!confirm("Tout supprimer ?")) return;
  const snap = await getDocs(collection(db, "entries"));
  for (const docu of snap.docs) {
    await deleteDoc(doc(db, "entries", docu.id));
  }
  await loadTable();
};
</script>
</body>
</html>
