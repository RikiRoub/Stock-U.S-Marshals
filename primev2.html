<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Agent - Primes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { text-align: center; }
        form, table { margin-bottom: 20px; width: 100%; }
        input, select, button { padding: 5px; margin: 5px 0; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        @media (max-width:600px){ input, select, button{width:100%;} }
    </style>
</head>
<body>
    <h1>Dashboard Agent</h1>
    <button onclick="window.location.href='index.html'">Accueil</button>

    <div id="forms-container"></div>

    <h2>Historique de vos activités (semaine en cours)</h2>
    <table>
        <thead>
            <tr>
                <th>Rôle</th>
                <th>Données</th>
                <th>Prime ($)</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="historyTableBody"></tbody>
    </table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0.appspot.com",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77",
    measurementId: "G-LX4G4FY0ZP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

const formsContainer = document.getElementById("forms-container");
const historyTableBody = document.getElementById("historyTableBody");

onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href="login.html"; return; }

    // Récupération des rôles
    const userDoc = await getDoc(doc(db,"users",user.uid));
    if(!userDoc.exists()){ alert("Utilisateur introuvable"); return; }
    const roles = userDoc.data().roles || [];

    // Création des formulaires dynamiques selon le rôle
    roles.forEach(role=>{
        const form = document.createElement("form");
        form.id = `form-${role}`;
        form.innerHTML = `<h3>${role}</h3>`;
        if(role==="FTF"){
            form.innerHTML += `
                Reward du Wanted: <input type="number" id="ftfReward" required>
                <button type="submit">Ajouter</button>
            `;
        } else if(role==="JSD"){
            form.innerHTML += `
                Durée audience (en minutes): <input type="number" id="jsdDuration" required>
                <button type="submit">Ajouter</button>
            `;
        } else if(role==="SRT" || role==="HC"){
            form.innerHTML += `
                Heures travaillées: <input type="number" id="${role}Hours" required>
                <button type="submit">Ajouter</button>
            `;
        } else if(role==="AFD"){
            form.innerHTML += `
                Nombre de convois: <input type="number" id="afdConvois" required>
                <button type="submit">Ajouter</button>
            `;
        } else if(role==="COM"){
            form.innerHTML += `
                Publications: <input type="number" id="comPub" required>
                Vidéos: <input type="number" id="comVid" required>
                <button type="submit">Ajouter</button>
            `;
        }
        formsContainer.appendChild(form);

        // Gestion de l'envoi du formulaire
        form.addEventListener("submit", async (e)=>{
            e.preventDefault();
            let data={}, prime=0;
            if(role==="FTF"){
                const reward = parseFloat(document.getElementById("ftfReward").value);
                data.reward = reward;
                prime = reward*0.065;
            } else if(role==="JSD"){
                let minutes = parseInt(document.getElementById("jsdDuration").value);
                let audiences = Math.ceil(minutes/60);
                data.minutes = minutes;
                prime = audiences*125;
            } else if(role==="SRT" || role==="HC"){
                let hours = parseFloat(document.getElementById(`${role}Hours`).value);
                data.hours = hours;
                prime = hours*50; // Exemple $50/h
            } else if(role==="AFD"){
                let convois = parseInt(document.getElementById("afdConvois").value);
                data.convois = convois;
                prime = convois*500;
            } else if(role==="COM"){
                let pub = parseInt(document.getElementById("comPub").value);
                let vid = parseInt(document.getElementById("comVid").value);
                data.publications = pub; data.videos=vid;
                prime = pub*250 + vid*500;
            }

            await addDoc(collection(db,"weeklyActivities"),{
                userId: user.uid,
                role: role,
                data: data,
                prime: prime,
                createdAt: Timestamp.fromDate(new Date())
            });

            alert("Activité ajoutée !");
            form.reset();
            loadHistory();
        });
    });

    loadHistory();
});

// Fonction pour afficher l'historique de la semaine
async function loadHistory(){
    const user = auth.currentUser;
    if(!user) return;

    const startWeek = new Date();
    const day = startWeek.getDay();
    const diff = startWeek.getDate() - day + (day===0? -6:1);
    startWeek.setDate(diff); startWeek.setHours(0,0,0,0);

    const q = query(
        collection(db,"weeklyActivities"),
        where("userId","==",user.uid),
        where("createdAt",">=", Timestamp.fromDate(startWeek)),
        orderBy("createdAt","asc")
    );

    const snapshot = await getDocs(q);
    historyTableBody.innerHTML="";
    snapshot.forEach(docSnap=>{
        const act = docSnap.data();
        const date = act.createdAt.toDate().toLocaleString();
        historyTableBody.innerHTML += `<tr>
            <td>${act.role}</td>
            <td>${JSON.stringify(act.data)}</td>
            <td>${act.prime.toFixed(2)}</td>
            <td>${date}</td>
        </tr>`;
    });
}
</script>
</body>
</html>
