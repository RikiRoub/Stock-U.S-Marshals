<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Agent - Primes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input, select, button { padding: 5px; margin: 2px; }
    button { cursor: pointer; }
</style>
</head>
<body>
<h1>Dashboard Agent</h1>
<button onclick="window.location.href='index.html'">Accueil</button>

<div id="tablesContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0.appspot.com",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77",
    measurementId: "G-LX4G4FY0ZP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

const tablesContainer = document.getElementById("tablesContainer");

onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href="login.html"; return; }

    const userDoc = await getDoc(doc(db,"users",user.uid));
    if(!userDoc.exists()){ alert("Utilisateur introuvable"); return; }
    const roles = userDoc.data().roles || [];

    roles.forEach(role=>{
        createRoleTable(role, user.uid);
    });
});

async function createRoleTable(role, userId){
    const tableWrapper = document.createElement("div");
    tableWrapper.innerHTML = `<h3>${role}</h3>
        <table id="table-${role}">
            <thead>
                <tr>
                    <th>Données</th>
                    <th>Prime ($)</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
                <tr>
                    <td id="inputs-${role}"></td>
                    <td></td>
                    <td></td>
                    <td><button id="add-${role}">Ajouter</button></td>
                </tr>
            </thead>
            <tbody></tbody>
        </table>`;
    tablesContainer.appendChild(tableWrapper);

    const tbody = tableWrapper.querySelector("tbody");
    const inputsTd = document.getElementById(`inputs-${role}`);

    // Création des champs d'entrée selon le rôle
    if(role==="FTF"){ inputsTd.innerHTML=`Reward: <input type="number" id="input-${role}-reward">`; }
    else if(role==="JSD"){ inputsTd.innerHTML=`Durée (min): <input type="number" id="input-${role}-duration">`; }
    else if(role==="SRT" || role==="HC"){ inputsTd.innerHTML=`Heures: <input type="number" id="input-${role}-hours">`; }
    else if(role==="AFD"){ inputsTd.innerHTML=`Convois: <input type="number" id="input-${role}-convois">`; }
    else if(role==="COM"){ inputsTd.innerHTML=`Pub: <input type="number" id="input-${role}-pub"> Vidéos: <input type="number" id="input-${role}-vid">`; }

    document.getElementById(`add-${role}`).addEventListener("click", async ()=>{
        let data={}, prime=0;
        if(role==="FTF"){ const r=parseFloat(document.getElementById(`input-${role}-reward`).value); data.reward=r; prime=r*0.065; }
        else if(role==="JSD"){ const m=parseInt(document.getElementById(`input-${role}-duration`).value); data.minutes=m; prime=Math.ceil(m/60)*125; }
        else if(role==="SRT" || role==="HC"){ const h=parseFloat(document.getElementById(`input-${role}-hours`).value); data.hours=h; prime=h*50; }
        else if(role==="AFD"){ const c=parseInt(document.getElementById(`input-${role}-convois`).value); data.convois=c; prime=c*500; }
        else if(role==="COM"){ const p=parseInt(document.getElementById(`input-${role}-pub`).value); const v=parseInt(document.getElementById(`input-${role}-vid`).value); data.publications=p; data.videos=v; prime=p*250+v*500; }

        const docRef = await addDoc(collection(db,"weeklyActivities"),{
            userId, role, data, prime, createdAt: new Date()
        });

        addRow(tbody, docRef.id, role, data, prime, new Date());
    });

    loadRoleActivities(role, userId, tbody);
}

async function loadRoleActivities(role, userId, tbody){
    const q = query(collection(db,"weeklyActivities"), where("userId","==",userId), where("role","==",role), orderBy("createdAt","asc"));
    const snapshot = await getDocs(q);
    snapshot.forEach(docSnap=>{
        const act = docSnap.data();
        addRow(tbody, docSnap.id, role, act.data, act.prime, act.createdAt.toDate());
    });
}

function addRow(tbody, id, role, data, prime, date){
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${JSON.stringify(data)}</td>
                  <td>${prime.toFixed(2)}</td>
                  <td>${date.toLocaleString()}</td>
                  <td><button>Supprimer</button></td>`;
    tr.querySelector("button").addEventListener("click", async ()=>{
        await deleteDoc(doc(db,"weeklyActivities",id));
        tr.remove();
    });
    tbody.appendChild(tr);
}
</script>
</body>
</html>
