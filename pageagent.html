<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Primes USMS</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

  <!-- Auth -->
  <div id="auth" class="max-w-md mx-auto bg-white p-4 rounded shadow">
    <h1 class="text-xl font-bold mb-2">Connexion / Inscription</h1>
    <input id="displayName" placeholder="Nom affiché" class="border p-2 w-full mb-2">
    <input id="email" type="email" placeholder="Email" class="border p-2 w-full mb-2">
    <input id="password" type="password" placeholder="Mot de passe" class="border p-2 w-full mb-2">

    <label>Rôles :</label>
    <select id="role" multiple class="border p-2 w-full mb-2">
      <option value="agent">Agent</option>
      <option value="hc">HC</option>
    </select>
    <p class="text-xs text-slate-500">Ctrl/Cmd + clic pour sélectionner plusieurs rôles</p>

    <input id="hcCode" placeholder="Code HC (si HC choisi)" class="border p-2 w-full mb-2">
    <button id="signupBtn" class="bg-blue-500 text-white p-2 rounded w-full">Créer un compte</button>
    <button id="loginBtn" class="bg-green-500 text-white p-2 rounded w-full mt-2">Se connecter</button>
  </div>

  <!-- App -->
  <div id="app" class="hidden max-w-2xl mx-auto bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-4">
      <div id="whoami"></div>
      <div>
        <button id="logoutBtn" class="bg-red-500 text-white p-1 px-3 rounded">Déconnexion</button>
        <a id="navHC" href="hc.html" class="bg-purple-500 text-white p-1 px-3 rounded hidden">Panel HC</a>
      </div>
    </div>

    <h2 class="font-bold mb-2">Entrée des primes</h2>

    <label>FTF – Reward du Wanted:</label>
    <input id="ftfReward" type="number" class="border p-2 w-full mb-2">

    <label>JSD – Nb audiences protégées :</label>
    <input id="jsdAud" type="number" class="border p-2 w-full mb-2">
    <label>JSD – Nb heures audiences (1h = 1 audience) :</label>
    <input id="jsdHours" type="number" class="border p-2 w-full mb-2">

    <label>SRT – Heures activité :</label>
    <input id="srtHours" type="number" class="border p-2 w-full mb-2">

    <label>AFD – Nb convois :</label>
    <input id="afdNb" type="number" class="border p-2 w-full mb-2">

    <label>Com – Publications :</label>
    <input id="comPub" type="number" class="border p-2 w-full mb-2">
    <label>Com – Vidéos :</label>
    <input id="comVid" type="number" class="border p-2 w-full mb-2">

    <label>HC – Heures activité :</label>
    <input id="hcHours" type="number" class="border p-2 w-full mb-2">

    <div class="mt-4 font-bold">Total : <span id="totalPrime">0</span> $</div>
    <button id="saveBtn" class="bg-blue-600 text-white p-2 mt-4 rounded">Enregistrer</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
  authDomain: "gestion-stock-d63d0.firebaseapp.com",
  projectId: "gestion-stock-d63d0",
  storageBucket: "gestion-stock-d63d0.firebasestorage.app",
  messagingSenderId: "865227689174",
  appId: "1:865227689174:web:213e7f6e44f183c6928d77"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const HC_CODE = "CODE_SECRET_HC";

function $(id) { return document.querySelector(id); }

async function ensureUserDoc(user, rolesChosen) {
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    await setDoc(ref, {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName || "",
      roles: rolesChosen || ["agent"],
      createdAt: serverTimestamp()
    });
  }
  return (await getDoc(ref)).data();
}

$("#signupBtn").onclick = async () => {
  const email = $("#email").value;
  const pass = $("#password").value;
  const displayName = $("#displayName").value;
  const roles = Array.from($("#role").selectedOptions).map(o => o.value);
  const code = $("#hcCode").value.trim();

  if (roles.includes("hc") && code !== HC_CODE) {
    alert("Code HC invalide.");
    return;
  }

  const { user } = await createUserWithEmailAndPassword(auth, email, pass);
  if (displayName) await updateProfile(user, { displayName });
  await ensureUserDoc(user, roles);
};

$("#loginBtn").onclick = async () => {
  await signInWithEmailAndPassword(auth, $("#email").value, $("#password").value);
};

$("#logoutBtn").onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    $("#auth").classList.remove("hidden");
    $("#app").classList.add("hidden");
    return;
  }
  const u = await ensureUserDoc(user);
  $("#auth").classList.add("hidden");
  $("#app").classList.remove("hidden");
  $("#whoami").textContent = `${u.displayName || u.email} – rôles: ${u.roles.join(", ")}`;
  $("#navHC").classList.toggle("hidden", !u.roles.includes("hc"));
});

function calcTotal() {
  const ftf = Number($("#ftfReward").value) * 0.065;
  const jsd = Number($("#jsdAud").value) * 125 + Math.max(0, Number($("#jsdHours").value) - Number($("#jsdAud").value)) * 125;
  const srt = Number($("#srtHours").value) * 50;
  const afd = Number($("#afdNb").value) * 500;
  const com = Number($("#comPub").value) * 250 + Number($("#comVid").value) * 500;
  const hc  = Number($("#hcHours").value) * 50;
  const total = ftf + jsd + srt + afd + com + hc;
  $("#totalPrime").textContent = total.toFixed(2);
  return total;
}

document.querySelectorAll("input").forEach(el => el.addEventListener("input", calcTotal));

$("#saveBtn").onclick = async () => {
  const total = calcTotal();
  await addDoc(collection(db, "entries"), {
    uid: auth.currentUser.uid,
    displayName: auth.currentUser.displayName || auth.currentUser.email,
    ftfReward: Number($("#ftfReward").value),
    jsdAud: Number($("#jsdAud").value),
    jsdHours: Number($("#jsdHours").value),
    srtHours: Number($("#srtHours").value),
    afdNb: Number($("#afdNb").value),
    comPub: Number($("#comPub").value),
    comVid: Number($("#comVid").value),
    hcHours: Number($("#hcHours").value),
    total,
    status: "pending",
    createdAt: serverTimestamp()
  });
  alert("Enregistré !");
};
</script>
</body>
</html>
