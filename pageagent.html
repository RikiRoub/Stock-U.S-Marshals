<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USMS – Primes (Agent)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase v10 (modular) -->
  <script type="module">
    // ====== Firebase SDKs ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc,
      collection, serverTimestamp, query, where, getDocs, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ====== CONFIG FIREBASE ======
    const firebaseConfig = {
      // TODO: REMPLACE ICI par ta configuration Firebase
      apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
      authDomain: "gestion-stock-d63d0.firebaseapp.com",
      projectId: "gestion-stock-d63d0",
      storageBucket: "gestion-stock-d63d0.firebasestorage.app",
      messagingSenderId: "865227689174",
      appId: "1:865227689174:web:213e7f6e44f183c6928d77"
    };

    // ====== CONSTANTES METIER ======
    const RATE_FTF_PCT = 0.065;     // 6.5% du wanted
    const RATE_JSD_PER_AUDIENCE = 125; // $125 / audience
    const RATE_AFD_PER_CONVOI = 500;   // $500 / convoi
    const RATE_COM_PUB = 250;          // $250 / publication
    const RATE_COM_VIDEO = 500;         // $500 / vidéo

    // Secret optionnel pour créer un compte HC au signup (à partager seulement aux HC)
    const HC_INVITE_CODE = "CHANGE_ME_HC_SECRET"; // <-- change ce code ou laisse vide pour interdire

    // ====== APP INIT ======
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Helpers
    const $ = (sel) => document.querySelector(sel);
    const monthKey = (d = new Date()) =>
      `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;

    // ========= AUTH UI =========
    async function ensureUserDoc(user, roleChosen) {
      const uref = doc(db, "users", user.uid);
      const snap = await getDoc(uref);
      if (!snap.exists()) {
        await setDoc(uref, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || "",
          role: roleChosen || "agent",
          createdAt: serverTimestamp()
        });
      }
      return (await getDoc(uref)).data();
    }

    async function doSignup(e) {
      e.preventDefault();
      const email = $("#email").value.trim();
      const pass = $("#password").value;
      const displayName = $("#displayName").value.trim();
      const role = $("#role").value; // agent ou hc
      const code = $("#hcCode").value.trim();

      if (role === "hc" && (!HC_INVITE_CODE || code !== HC_INVITE_CODE)) {
        alert("Code HC invalide.");
        return;
      }

      const { user } = await createUserWithEmailAndPassword(auth, email, pass);
      if (displayName) await updateProfile(user, { displayName });
      await ensureUserDoc(user, role);
    }

    async function doSignin(e) {
      e.preventDefault();
      const email = $("#email").value.trim();
      const pass = $("#password").value;
      await signInWithEmailAndPassword(auth, email, pass);
    }

    async function doLogout() {
      await signOut(auth);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        $("#auth").classList.remove("hidden");
        $("#app").classList.add("hidden");
        return;
      }
      $("#auth").classList.add("hidden");
      $("#app").classList.remove("hidden");
      const u = await ensureUserDoc(user);

      $("#whoami").textContent = `${u.displayName || u.email} – rôle: ${u.role}`;
      $("#navHC").classList.toggle("hidden", u.role !== "hc");

      // Charger les paramètres (taux horaires SRT/HC)
      await loadSettings();
      // Pré-remplir la période (mois courant)
      $("#period").value = monthKey();
      recalc(); // calcule à zéro
      await loadLastDraft();
    });

    // ========= CALCULS =========
    function ceilAudiencesFromHours(hours) {
      const h = Number(hours) || 0;
      // 1 audience couvre la 1ère heure ; chaque heure suivante = +1 audience
      // => nombre d'audiences = ceil(h)
      return Math.ceil(h);
    }

    function recalc() {
      const reward = Number($("#ftfReward").value) || 0;
      const ftf = reward * RATE_FTF_PCT;

      const jsdHours = Number($("#jsdHours").value) || 0;
      const jsdExtraCount = Number($("#jsdCount").value) || 0;
      const audiencesFromHours = ceilAudiencesFromHours(jsdHours);
      const jsdTotalAudiences = audiencesFromHours + jsdExtraCount;
      const jsd = jsdTotalAudiences * RATE_JSD_PER_AUDIENCE;

      const srtHours = Number($("#srtHours").value) || 0;
      const hcHours  = Number($("#hcHours").value) || 0;
      const srtRate = Number($("#rateSRT").dataset.value) || 0;
      const hcRate  = Number($("#rateHC").dataset.value) || 0;
      const srt = srtHours * srtRate;
      const hc  = hcHours  * hcRate;

      const afdConvoys = Number($("#afdConvoys").value) || 0;
      const afd = afdConvoys * RATE_AFD_PER_CONVOI;

      const comPub = Number($("#comPub").value) || 0;
      const comVid = Number($("#comVid").value) || 0;
      const com = comPub * RATE_COM_PUB + comVid * RATE_COM_VIDEO;

      const total = ftf + jsd + srt + afd + com + hc;

      $("#outFTF").textContent = `$${ftf.toFixed(2)}`;
      $("#outJSD").textContent = `$${jsd.toFixed(2)} (${jsdTotalAudiences} audience(s))`;
      $("#outSRT").textContent = `$${srt.toFixed(2)} (${srtHours}h @ $${srtRate}/h)`;
      $("#outAFD").textContent = `$${afd.toFixed(2)}`;
      $("#outCOM").textContent = `$${com.toFixed(2)}`;
      $("#outHC").textContent  = `$${hc.toFixed(2)} (${hcHours}h @ $${hcRate}/h)`;
      $("#outTOTAL").textContent = `$${total.toFixed(2)}`;
    }

    // ========= PERSISTENCE =========
    async function saveEntry() {
      const user = auth.currentUser;
      if (!user) return;

      const period = $("#period").value.trim() || monthKey();

      const payload = {
        uid: user.uid,
        period,
        createdAt: serverTimestamp(),
        status: "unpaid",
        categories: {
          FTF: {
            reward: Number($("#ftfReward").value) || 0,
            amount: Number($("#outFTF").textContent.replace("$","")) || 0
          },
          JSD: {
            hours: Number($("#jsdHours").value) || 0,
            extraCount: Number($("#jsdCount").value) || 0,
            amount: Number($("#outJSD").textContent.replace("$","")) || 0
          },
          SRT: {
            hours: Number($("#srtHours").value) || 0,
            rate: Number($("#rateSRT").dataset.value) || 0,
            amount: Number($("#outSRT").textContent.replace("$","")) || 0
          },
          AFD: {
            convoys: Number($("#afdConvoys").value) || 0,
            amount: Number($("#outAFD").textContent.replace("$","")) || 0
          },
          COM: {
            publications: Number($("#comPub").value) || 0,
            videos: Number($("#comVid").value) || 0,
            amount: Number($("#outCOM").textContent.replace("$","")) || 0
          },
          HC: {
            hours: Number($("#hcHours").value) || 0,
            rate: Number($("#rateHC").dataset.value) || 0,
            amount: Number($("#outHC").textContent.replace("$","")) || 0
          }
        },
        total: Number($("#outTOTAL").textContent.replace("$","")) || 0,
        note: $("#note").value.trim()
      };

      await addDoc(collection(db, "entries"), payload);
      alert("Entrée enregistrée !");
      // sauvegarde de brouillon minimal pour confort
      localStorage.setItem("usms_draft_"+user.uid, JSON.stringify({
        period: payload.period,
        ftfReward: $("#ftfReward").value,
        jsdHours: $("#jsdHours").value,
        jsdCount: $("#jsdCount").value,
        srtHours: $("#srtHours").value,
        afdConvoys: $("#afdConvoys").value,
        comPub: $("#comPub").value,
        comVid: $("#comVid").value,
        hcHours: $("#hcHours").value,
        note: $("#note").value
      }));
    }

    async function loadLastDraft() {
      const user = auth.currentUser;
      if (!user) return;
      const raw = localStorage.getItem("usms_draft_"+user.uid);
      if (!raw) return;
      try {
        const d = JSON.parse(raw);
        if (d.period) $("#period").value = d.period;
        $("#ftfReward").value = d.ftfReward || "";
        $("#jsdHours").value = d.jsdHours || "";
        $("#jsdCount").value = d.jsdCount || "";
        $("#srtHours").value = d.srtHours || "";
        $("#afdConvoys").value = d.afdConvoys || "";
        $("#comPub").value = d.comPub || "";
        $("#comVid").value = d.comVid || "";
        $("#hcHours").value = d.hcHours || "";
        $("#note").value = d.note || "";
        recalc();
      } catch {}
    }

    // ======== SETTINGS (taux horaires) ========
    async function loadSettings() {
      // Document unique
      const sref = doc(db, "settings", "rates");
      const snap = await getDoc(sref);
      const data = snap.exists() ? snap.data() : { rateSRT: 0, rateHC: 0 };
      $("#rateSRT").textContent = `$${(data.rateSRT||0).toFixed(2)}/h`;
      $("#rateSRT").dataset.value = data.rateSRT || 0;
      $("#rateHC").textContent = `$${(data.rateHC||0).toFixed(2)}/h`;
      $("#rateHC").dataset.value = data.rateHC || 0;
      recalc();
    }

    // ======== UI WIRING ========
    window.addEventListener("DOMContentLoaded", () => {
      // Auth
      $("#signin").addEventListener("click", doSignin);
      $("#signup").addEventListener("click", doSignup);
      $("#logout").addEventListener("click", doLogout);

      // Inputs -> recalcul
      ["ftfReward","jsdHours","jsdCount","srtHours","afdConvoys","comPub","comVid","hcHours"]
        .forEach(id => $("#"+id).addEventListener("input", recalc));

      $("#save").addEventListener("click", saveEntry);
    });
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- AUTH -->
  <section id="auth" class="max-w-xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow hidden">
    <h1 class="text-2xl font-bold mb-4">Connexion / Création de compte</h1>
    <div class="grid gap-3">
      <input id="displayName" class="border rounded p-2" placeholder="Pseudo (optionnel)">
      <input id="email" type="email" class="border rounded p-2" placeholder="Email">
      <input id="password" type="password" class="border rounded p-2" placeholder="Mot de passe">
      <div class="flex items-center gap-2">
        <label class="text-sm">Rôle :</label>
        <select id="role" class="border rounded p-2">
          <option value="agent">Agent</option>
          <option value="hc">HC</option>
        </select>
      </div>
      <input id="hcCode" class="border rounded p-2" placeholder="Code secret HC (si HC)">
      <div class="flex gap-2">
        <button id="signin
