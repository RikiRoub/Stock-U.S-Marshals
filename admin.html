<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panneau Admin - Gestion des rôles</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
        select, button { padding: 5px; }
        .logout { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Gestion des rôles utilisateurs</h1>
    <p id="status"></p>
    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Rôle</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="users-table"></tbody>
    </table>
    <button class="logout" onclick="logout()">Se déconnecter</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Config Firebase (remplace par la tienne)
        const firebaseConfig = {
              apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
              authDomain: "gestion-stock-d63d0.firebaseapp.com",
              projectId: "gestion-stock-d63d0",
              storageBucket: "gestion-stock-d63d0.firebasestorage.app",
              messagingSenderId: "865227689174",
              appId: "1:865227689174:web:213e7f6e44f183c6928d77",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Vérification ADMIN
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().role !== "ADMIN") {
                document.getElementById("status").innerText = "Accès refusé. Rôle ADMIN requis.";
                return;
            }

            document.getElementById("status").innerText = "Connecté en tant qu'ADMIN";
            loadUsers();
        });

        // Charger tous les utilisateurs
        async function loadUsers() {
            const querySnapshot = await getDocs(collection(db, "users"));
            const tableBody = document.getElementById("users-table");
            tableBody.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const tr = document.createElement("tr");

                // Email
                const tdEmail = document.createElement("td");
                tdEmail.innerText = data.email || "Inconnu";
                tr.appendChild(tdEmail);

                // Sélecteur de rôle
                const tdRole = document.createElement("td");
                const select = document.createElement("select");
                ["pending", "ADMIN", "AFD", "USMS", "SRT", "HC", "COM"].forEach(role => {
                    const option = document.createElement("option");
                    option.value = role;
                    option.text = role;
                    if (data.role === role) option.selected = true;
                    select.appendChild(option);
                });
                tdRole.appendChild(select);
                tr.appendChild(tdRole);

                // Bouton sauvegarder
                const tdAction = document.createElement("td");
                const btn = document.createElement("button");
                btn.innerText = "Sauvegarder";
                btn.onclick = async () => {
                    await updateDoc(doc(db, "users", docSnap.id), { role: select.value });
                    alert(`Rôle mis à jour pour ${data.email}`);
                };
                tdAction.appendChild(btn);
                tr.appendChild(tdAction);

                tableBody.appendChild(tr);
            });
        }

        // Déconnexion
        function logout() {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            });
        }
    </script>
</body>
</html>
