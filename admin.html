<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panneau Admin - Gestion des rôles</title>
    <style>
        body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
        button, input { padding: 5px; margin: 2px; }
        .logout { margin-top: 20px; }
        .add-user { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Gestion des rôles utilisateurs</h1>
    <p id="status"></p>

    <!-- Formulaire ajout utilisateur -->
    <div class="add-user">
        <input type="email" id="newEmail" placeholder="Email utilisateur" />
        <button onclick="addUser()">Ajouter utilisateur</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Rôles</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="users-table"></tbody>
    </table>
    <button class="logout" onclick="logout()">Se déconnecter</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
            authDomain: "gestion-stock-d63d0.firebaseapp.com",
            projectId: "gestion-stock-d63d0",
            storageBucket: "gestion-stock-d63d0.firebasestorage.app",
            messagingSenderId: "865227689174",
            appId: "1:865227689174:web:213e7f6e44f183c6928d77",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const allRoles = ["ADMIN", "AFD", "USMS", "SRT", "HC", "COM", "pending"];

        // Vérification ADMIN
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            const userDoc = await getDoc(doc(db, "users", user.uid));
            const userData = userDoc.data();

            if (!userDoc.exists() || !userData.roles || !userData.roles.includes("ADMIN")) {
                document.getElementById("status").innerText = "Accès refusé. Rôle ADMIN requis.";
                return;
            }

            document.getElementById("status").innerText = `Connecté en tant qu'ADMIN: ${user.email}`;
            loadUsers();
        });

        // Charger tous les utilisateurs
        async function loadUsers() {
            const querySnapshot = await getDocs(collection(db, "users"));
            const tableBody = document.getElementById("users-table");
            tableBody.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const tr = document.createElement("tr");

                // Email
                const tdEmail = document.createElement("td");
                tdEmail.innerText = data.email || "Inconnu";
                tr.appendChild(tdEmail);

                // Cases à cocher pour les rôles
                const tdRoles = document.createElement("td");
                allRoles.forEach(role => {
                    const label = document.createElement("label");
                    label.style.marginRight = "8px";
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.value = role;
                    checkbox.checked = data.roles && data.roles.includes(role);
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(role));
                    tdRoles.appendChild(label);
                });
                tr.appendChild(tdRoles);

                // Actions: sauvegarder et supprimer
                const tdActions = document.createElement("td");

                const saveBtn = document.createElement("button");
                saveBtn.innerText = "Sauvegarder";
                saveBtn.onclick = async () => {
                    const selectedRoles = Array.from(tdRoles.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
                    await updateDoc(doc(db, "users", docSnap.id), { roles: selectedRoles });
                    alert(`Rôles mis à jour pour ${data.email}`);
                };
                tdActions.appendChild(saveBtn);

                const deleteBtn = document.createElement("button");
                deleteBtn.innerText = "Supprimer";
                deleteBtn.style.marginLeft = "5px";
                deleteBtn.onclick = async () => {
                    if (confirm(`Supprimer l'utilisateur ${data.email} ?`)) {
                        await deleteDoc(doc(db, "users", docSnap.id));
                        alert(`Utilisateur ${data.email} supprimé`);
                        loadUsers();
                    }
                };
                tdActions.appendChild(deleteBtn);

                tr.appendChild(tdActions);
                tableBody.appendChild(tr);
            });
        }

        // Ajouter un nouvel utilisateur (sans mot de passe, juste dans Firestore)
        async function addUser() {
            const email = document.getElementById("newEmail").value.trim();
            if (!email) return alert("Veuillez entrer un email");

            // On génère un ID temporaire (Firestore) pour l'utilisateur
            const newUserRef = doc(collection(db, "users"));
            await setDoc(newUserRef, {
                email,
                roles: ["pending"]
            });

            alert(`Utilisateur ${email} ajouté avec rôle pending`);
            document.getElementById("newEmail").value = "";
            loadUsers();
        }

        function logout() {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            });
        }
    </script>
</body>
</html>
