<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Agent - Primes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
        h2 { margin-top: 30px; }
        form { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        input, select, button { padding: 5px; margin: 5px 0; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<h1>Dashboard Agent</h1>
<p id="welcome-msg"></p>

<!-- FTF Section -->
<div id="ftf-section" class="hidden">
    <h2>FTF - Saisir Reward</h2>
    <form id="ftf-form">
        <input type="number" id="ftf-reward" placeholder="Reward Wanted $" required>
        <button type="submit">Calculer Prime</button>
    </form>
    <p>Prime calculée: $<span id="ftf-prime">0</span></p>
</div>

<!-- JSD Section -->
<div id="jsd-section" class="hidden">
    <h2>JSD - Audience Protection</h2>
    <form id="jsd-form">
        <input type="number" id="jsd-audience-hours" placeholder="Durée de l'audience (heures)" required>
        <button type="submit">Calculer Prime</button>
    </form>
    <p>Prime de la semaine: $<span id="jsd-prime">0</span></p>
</div>

<!-- SRT Section -->
<div id="srt-section" class="hidden">
    <h2>SRT - Prime d'activité</h2>
    <form id="srt-form">
        <input type="number" id="srt-hours" placeholder="Nombre d'heures" required>
        <button type="submit">Calculer Prime</button>
    </form>
    <p>Prime de la semaine: $<span id="srt-prime">0</span></p>
</div>

<!-- AFD Section -->
<div id="afd-section" class="hidden">
    <h2>AFD - Convois</h2>
    <form id="afd-form">
        <input type="number" id="afd-convois" placeholder="Nombre de convois" required>
        <button type="submit">Calculer Prime</button>
    </form>
    <p>Prime de la semaine: $<span id="afd-prime">0</span></p>
</div>

<!-- COM Section -->
<div id="com-section" class="hidden">
    <h2>COM - Publications / Vidéos</h2>
    <form id="com-form">
        <input type="number" id="com-publications" placeholder="Nombre de publications" required>
        <input type="number" id="com-videos" placeholder="Nombre de vidéos" required>
        <button type="submit">Calculer Prime</button>
    </form>
    <p>Prime de la semaine: $<span id="com-prime">0</span></p>
</div>

<!-- HC Section -->
<div id="hc-section" class="hidden">
    <h2>HC - Prime d'activité</h2>
    <form id="hc-form">
        <input type="number" id="hc-hours" placeholder="Nombre d'heures" required>
        <button type="submit">Calculer Prime</button>
    </form>
    <p>Prime de la semaine: $<span id="hc-prime">0</span></p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
        authDomain: "gestion-stock-d63d0.firebaseapp.com",
        projectId: "gestion-stock-d63d0",
        storageBucket: "gestion-stock-d63d0.appspot.com",
        messagingSenderId: "865227689174",
        appId: "1:865227689174:web:213e7f6e44f183c6928d77",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentRoles = [];

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) { alert("Utilisateur introuvable"); window.location.href="login.html"; return; }
        currentRoles = docSnap.data().roles || [];
        document.getElementById("welcome-msg").innerText = `Connecté en tant que ${user.email} - Rôles: ${currentRoles.join(", ")}`;

        // Afficher uniquement les sections selon les rôles
        if (currentRoles.includes("FTF")) document.getElementById("ftf-section").classList.remove("hidden");
        if (currentRoles.includes("JSD")) document.getElementById("jsd-section").classList.remove("hidden");
        if (currentRoles.includes("SRT")) document.getElementById("srt-section").classList.remove("hidden");
        if (currentRoles.includes("AFD")) document.getElementById("afd-section").classList.remove("hidden");
        if (currentRoles.includes("COM")) document.getElementById("com-section").classList.remove("hidden");
        if (currentRoles.includes("HC")) document.getElementById("hc-section").classList.remove("hidden");
    });

    // Fonctions de calcul des primes
    document.getElementById("ftf-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const reward = parseFloat(document.getElementById("ftf-reward").value);
        const prime = reward * 0.065;
        document.getElementById("ftf-prime").innerText = prime.toFixed(2);
    });

    document.getElementById("jsd-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        let hours = parseFloat(document.getElementById("jsd-audience-hours").value);
        let prime = 125; // 1ère audience
        if(hours > 1) prime += 125 * Math.floor(hours - 1); // chaque heure supplémentaire = nouvelle audience
        document.getElementById("jsd-prime").innerText = prime.toFixed(2);
    });

    document.getElementById("srt-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const hours = parseFloat(document.getElementById("srt-hours").value);
        const prime = hours * 20; // exemple $20/heure
        document.getElementById("srt-prime").innerText = prime.toFixed(2);
    });

    document.getElementById("afd-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const convois = parseInt(document.getElementById("afd-convois").value);
        const prime = convois * 500;
        document.getElementById("afd-prime").innerText = prime.toFixed(2);
    });

    document.getElementById("com-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const publications = parseInt(document.getElementById("com-publications").value);
        const videos = parseInt(document.getElementById("com-videos").value);
        const prime = (publications * 250) + (videos * 500);
        document.getElementById("com-prime").innerText = prime.toFixed(2);
    });

    document.getElementById("hc-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const hours = parseFloat(document.getElementById("hc-hours").value);
        const prime = hours * 25; // exemple $25/heure
        document.getElementById("hc-prime").innerText = prime.toFixed(2);
    });
</script>

</body>
</html>
