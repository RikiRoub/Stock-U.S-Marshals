<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des rôles</title>
</head>
<body>
    <h1>Gestion des rôles</h1>

    <div>
        <input type="email" id="emailUser" placeholder="Email de l'utilisateur">
        <button id="btnRechercher">Rechercher</button>
    </div>

    <div id="rolesSection" style="display:none; margin-top:20px;">
        <h3>Rôles de l'utilisateur :</h3>
        <ul id="listeRoles"></ul>

        <input type="text" id="nouveauRole" placeholder="Ajouter un rôle">
        <button id="btnAjouterRole">Ajouter rôle</button>
        <button id="btnSupprimerRole">Supprimer rôle</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
          authDomain: "gestion-stock-d63d0.firebaseapp.com",
          projectId: "gestion-stock-d63d0",
          storageBucket: "gestion-stock-d63d0.firebasestorage.app",
          messagingSenderId: "865227689174",
          appId: "1:865227689174:web:213e7f6e44f183c6928d77",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserDoc = null;

        const emailInput = document.getElementById("emailUser");
        const btnRechercher = document.getElementById("btnRechercher");
        const rolesSection = document.getElementById("rolesSection");
        const listeRoles = document.getElementById("listeRoles");
        const nouveauRoleInput = document.getElementById("nouveauRole");
        const btnAjouterRole = document.getElementById("btnAjouterRole");
        const btnSupprimerRole = document.getElementById("btnSupprimerRole");

        async function rechercherUtilisateur(emailRecherche) {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", emailRecherche));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("Utilisateur non trouvé");
                rolesSection.style.display = "none";
                currentUserDoc = null;
                return;
            }

            querySnapshot.forEach((docSnap) => {
                currentUserDoc = docSnap;
            });

            afficherRoles();
            rolesSection.style.display = "block";
        }

        function afficherRoles() {
            const data = currentUserDoc.data();
            listeRoles.innerHTML = "";
            if (!data.roles) data.roles = [];
            data.roles.forEach(role => {
                const li = document.createElement("li");
                li.textContent = role;
                listeRoles.appendChild(li);
            });
        }

        async function ajouterRole(role) {
            if (!currentUserDoc) return;
            const docRef = doc(db, "users", currentUserDoc.id);
            await updateDoc(docRef, { roles: arrayUnion(role) });
            await currentUserDoc.ref.get().then(docSnap => currentUserDoc = docSnap);
            afficherRoles();
        }

        async function supprimerRole(role) {
            if (!currentUserDoc) return;
            const docRef = doc(db, "users", currentUserDoc.id);
            await updateDoc(docRef, { roles: arrayRemove(role) });
            await currentUserDoc.r
