<div id="hc-admin" class="tabcontent">
  <h2>HC - Administration des primes</h2>
  <button id="reset-primes-btn" style="background:red;color:white;padding:8px 12px;border:none;border-radius:5px;margin-bottom:10px;">RÃ©initialiser toutes les primes</button>
  <table id="hc-admin-table">
    <thead>
      <tr>
        <th>Agent</th>
        <th>Heures</th>
        <th>Prime</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

async function loadHCAdmin() {
    const tableBody = document.querySelector("#hc-admin-table tbody");
    tableBody.innerHTML = "";

    const snapshot = await getDocs(collection(db, "userActivities"));
    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const userId = docSnap.id;

        if(data.hc && data.hc.length){
            data.hc.forEach((act, idx) => {
                const prime = act.hours * 30;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${userId}</td>
                    <td><input type="number" value="${act.hours}" data-user="${userId}" data-index="${idx}" class="hc-hours-input"></td>
                    <td>${prime.toFixed(2)}</td>
                    <td><button class="save-btn" data-user="${userId}" data-index="${idx}">Enregistrer</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
    });

    tableBody.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
            const userId = e.target.dataset.user;
            const idx = parseInt(e.target.dataset.index);
            const input = document.querySelector(`.hc-hours-input[data-user="${userId}"][data-index="${idx}"]`);
            const newHours = parseFloat(input.value);

            const userDocRef = doc(db, "userActivities", userId);
            const userSnap = await getDoc(userDocRef);
            if(userSnap.exists()){
                const userData = userSnap.data();
                userData.hc[idx].hours = newHours;
                await setDoc(userDocRef, userData, {merge:true});
                loadHCAdmin(); // refresh
            }
        });
    });
}

// Bouton pour reset toutes les primes HC
document.getElementById("reset-primes-btn").addEventListener("click", async () => {
    const snapshot = await getDocs(collection(db, "userActivities"));
    for(const docSnap of snapshot.docs){
        const data = docSnap.data();
        if(data.hc){
            data.hc = []; // reset toutes les heures HC
            await setDoc(doc(db, "userActivities", docSnap.id), data, {merge:true});
        }
    }
    loadHCAdmin(); // refresh
});

// Afficher ce panneau uniquement pour les admins HC
onAuthStateChanged(auth, async user => {
    if(!user) return;
    const userSnap = await getDoc(doc(db, "userActivities", user.uid));
    const roles = userSnap.exists() ? userSnap.data().roles || [] : [];
    if(!roles.includes("hc")){
        document.querySelector(".tablinks[data-role='hc']").style.display="none";
        return;
    }
    openTab("hc-admin");
    loadHCAdmin();
});
</script>
