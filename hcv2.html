<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Agent</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; background:#f7f9fc; }
h1 { margin-bottom: 20px; text-align:center; }
#welcome-msg { text-align:center; margin-bottom:20px; font-weight:bold; }

.tab { display:flex; justify-content: space-around; margin-bottom:10px; flex-wrap:wrap; gap:5px;}
.tab button { flex:1; min-width:100px; padding:10px 0; border:none; cursor:pointer; color:white; font-weight:bold; transition:0.3s; display:flex; justify-content:center; align-items:center; gap:5px; border-radius:5px 5px 0 0; }
.tab button.active { box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.tabcontent { display:none; padding:20px; background:white; border-radius:0 5px 5px 5px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
form { margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
input, button { padding:8px; border:1px solid #ccc; border-radius:5px; }
button[type="submit"] { background:#4CAF50; color:white; border:none; cursor:pointer; transition:0.3s; }
button[type="submit"]:hover { background:#45a049; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f2f2f2; }
button.delete-btn { background:red; color:white; border:none; border-radius:3px; cursor:pointer; padding:5px 8px; }
</style>
</head>
<body>

<h1>Dashboard Agent</h1>
<p id="welcome-msg"></p>

<div class="tab" id="tabs">
  <button class="tablinks" data-role="ftf" style="background:#FF6B6B;"><i class="bi bi-people-fill"></i> FTF</button>
  <button class="tablinks" data-role="jsd" style="background:#4D96FF;"><i class="bi bi-shield-fill"></i> JSD</button>
  <button class="tablinks" data-role="srt" style="background:#FFD93D;"><i class="bi bi-clock-fill"></i> SRT</button>
  <button class="tablinks" data-role="afd" style="background:#6BCB77;"><i class="bi bi-truck"></i> AFD</button>
  <button class="tablinks" data-role="com" style="background:#FF6BDB;"><i class="bi bi-camera-video-fill"></i> COM</button>
  <button class="tablinks" data-role="hc" style="background:#845EC2;"><i class="bi bi-house-fill"></i> HC</button>
</div>

<!-- Sections onglets -->
<div id="ftf" class="tabcontent">
  <h2>FTF - Reward</h2>
  <form id="ftf-form">
      <input type="number" id="ftf-reward" placeholder="Reward $" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="ftf-total-prime">0</span></p>
  <table id="ftf-table"><thead><tr><th>Reward</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="jsd" class="tabcontent">
  <h2>JSD - Audience Protection</h2>
  <form id="jsd-form">
      <input type="number" id="jsd-hours" placeholder="Durée (heures)" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="jsd-total-prime">0</span></p>
  <table id="jsd-table"><thead><tr><th>Heures</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="srt" class="tabcontent">
  <h2>SRT - Prime</h2>
  <form id="srt-form">
      <input type="number" id="srt-hours" placeholder="Nombre d'heures" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="srt-total-prime">0</span></p>
  <table id="srt-table"><thead><tr><th>Heures</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="afd" class="tabcontent">
  <h2>AFD - Convois</h2>
  <form id="afd-form">
      <input type="number" id="afd-convois" placeholder="Nombre de convois" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="afd-total-prime">0</span></p>
  <table id="afd-table"><thead><tr><th>Convois</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="com" class="tabcontent">
  <h2>COM - Publications / Vidéos</h2>
  <form id="com-form">
      <input type="number" id="com-publications" placeholder="Publications" required>
      <input type="number" id="com-videos" placeholder="Vidéos" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="com-total-prime">0</span></p>
  <table id="com-table"><thead><tr><th>Publications</th><th>Vidéos</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<div id="hc" class="tabcontent">
  <h2>HC - Prime</h2>
  <form id="hc-form">
      <input type="number" id="hc-hours" placeholder="Nombre d'heures" required>
      <button type="submit">Ajouter</button>
  </form>
  <p>Prime totale: $<span id="hc-total-prime">0</span></p>
  <table id="hc-table"><thead><tr><th>Heures</th><th>Prime</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<!-- Résumé agents -->
<div id="summary" class="tabcontent">
  <h2>Résumé Agents</h2>
  <table id="summary-table">
    <thead>
      <tr>
        <th>Agent</th>
        <th>FTF</th>
        <th>JSD</th>
        <th>SRT</th>
        <th>AFD</th>
        <th>COM</th>
        <th>HC</th>
        <th>Total Prime</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userActivities = { ftf: [], jsd: [], srt: [], afd: [], com: [], hc: [] };
const primeFuncs = {
    ftf: r => r*0.5, jsd: h => h*10, srt: h => h*15, afd: c => c*20, com: (p,v)=>p*5+v*10, hc: h=>h*25
};

const tablinks = document.querySelectorAll(".tablinks");

tablinks.forEach(btn => {
    btn.addEventListener("click", ()=>openTab(btn.dataset.role));
});

function openTab(role){
    document.querySelectorAll(".tabcontent").forEach(t=>t.style.display="none");
    document.getElementById(role).style.display="block";
    tablinks.forEach(b=>b.classList.remove("active"));
    document.querySelector(`.tablinks[data-role="${role}"]`).classList.add("active");
    if(role==="summary") renderSummary();
}

function updateTable(type){
    const tbody = document.querySelector(`#${type}-table tbody`);
    tbody.innerHTML="";
    let total=0;
    if(type==="com"){
        userActivities[type].forEach(entry=>{
            const prime = primeFuncs.com(entry.publications, entry.videos);
            total+=prime;
            tbody.innerHTML+=`<tr><td>${entry.publications}</td><td>${entry.videos}</td><td>${prime.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteEntry('${type}',${userActivities[type].indexOf(entry)})">X</button></td></tr>`;
        });
    } else {
        userActivities[type].forEach((entry,i)=>{
            const value = Object.values(entry)[0];
            const prime = primeFuncs[type](value);
            total+=prime;
            tbody.innerHTML+=`<tr><td>${value}</td><td>${prime.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteEntry('${type}',${i})">X</button></td></tr>`;
        });
    }
    document.getElementById(`${type}-total-prime`).innerText=total.toFixed(2);
}

window.deleteEntry = function(type,index){
    userActivities[type].splice(index,1);
    updateTable(type);
}

// Formulaire FTF
document.getElementById("ftf-form").addEventListener("submit", e=>{
    e.preventDefault();
    const val = Number(document.getElementById("ftf-reward").value);
    userActivities.ftf.push({reward:val});
    updateTable("ftf");
    e.target.reset();
});

// Formulaire JSD
document.getElementById("jsd-form").addEventListener("submit", e=>{
    e.preventDefault();
    const val = Number(document.getElementById("jsd-hours").value);
    userActivities.jsd.push({hours:val});
    updateTable("jsd");
    e.target.reset();
});

// Formulaire SRT
document.getElementById("srt-form").addEventListener("submit", e=>{
    e.preventDefault();
    const val = Number(document.getElementById("srt-hours").value);
    userActivities.srt.push({hours:val});
    updateTable("srt");
    e.target.reset();
});

// Formulaire AFD
document.getElementById("afd-form").addEventListener("submit", e=>{
    e.preventDefault();
    const val = Number(document.getElementById("afd-convois").value);
    userActivities.afd.push({convois:val});
    updateTable("afd");
    e.target.reset();
});

// Formulaire COM
document.getElementById("com-form").addEventListener("submit", e=>{
    e.preventDefault();
    const p = Number(document.getElementById("com-publications").value);
    const v = Number(document.getElementById("com-videos").value);
    userActivities.com.push({publications:p, videos:v});
    updateTable("com");
    e.target.reset();
});

// Formulaire HC
document.getElementById("hc-form").addEventListener("submit", e=>{
    e.preventDefault();
    const val = Number(document.getElementById("hc-hours").value);
    userActivities.hc.push({hours:val});
    updateTable("hc");
    e.target.reset();
});

// Récapitulatif HC
async function renderSummary(){
    const tbody = document.querySelector("#summary-table tbody");
    tbody.innerHTML="";
    const usersSnapshot = await getDocs(collection(db,"userActivities"));
    usersSnapshot.forEach(doc=>{
        const data = doc.data();
        let total = 0;
        const primes = {
            ftf: data.ftf ? data.ftf.reduce((sum,a)=>sum + primeFuncs.ftf(a.reward),0) :0,
            jsd: data.jsd ? data.jsd.reduce((sum,a)=>sum + primeFuncs.jsd(a.hours),0):0,
            srt: data.srt ? data.srt.reduce((sum,a)=>sum + primeFuncs.srt(a.hours),0):0,
            afd: data.afd ? data.afd.reduce((sum,a)=>sum + primeFuncs.afd(a.convois),0):0,
            com: data.com ? data.com.reduce((sum,a)=>sum + primeFuncs.com(a.publications,a.videos),0):0,
            hc: data.hc ? data.hc.reduce((sum,a)=>sum + primeFuncs.hc(a.hours),0):0
        };
        total = Object.values(primes).reduce((a,b)=>a+b,0);
        const row = document.createElement("tr");
        row.innerHTML=`
        <td>${doc.id}</td>
        <td>${primes.ftf.toFixed(2)}</td>
        <td>${primes.jsd.toFixed(2)}</td>
        <td>${primes.srt.toFixed(2)}</td>
        <td>${primes.afd.toFixed(2)}</td>
        <td>${primes.com.toFixed(2)}</td>
        <td>${primes.hc.toFixed(2)}</td>
        <td>${total.toFixed(2)}</td>`;
        tbody.appendChild(row);
    });
}

// Auth + rôle HC
onAuthStateChanged(auth,user=>{
    if(!user) return;
    document.getElementById("welcome-msg").innerText=`Bienvenue ${user.email}`;
    getDoc(doc(db,"userActivities",user.uid)).then(docSnap=>{
        if(docSnap.exists()) userActivities = docSnap.data();
        updateTable("ftf"); updateTable("jsd"); updateTable("srt");
        updateTable("afd"); updateTable("com"); updateTable("hc");
    });
    getDoc(doc(db,"roles",user.uid)).then(roleSnap=>{
        if(roleSnap.exists() && roleSnap.data().role==="hc"){
            const summaryBtn = document.createElement("button");
            summaryBtn.classList.add("tablinks");
            summaryBtn.style.background="#333";
            summaryBtn.innerHTML='<i class="bi bi-list-check"></i> Résumé Agents';
            summaryBtn.dataset.role="summary";
            document.getElementById("tabs").appendChild(summaryBtn);
            summaryBtn.addEventListener("click",()=>openTab("summary"));
        }
    });
});

// Afficher FTF par défaut
openTab("ftf");
</script>
</body>
</html>
