<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0.appspot.com",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77",
    measurementId: "G-LX4G4FY0ZP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

const hcTableBody = document.querySelector("#hc-table tbody");
const totalTableBody = document.querySelector("#total-table tbody");
const exportBtn = document.getElementById("export-btn");

function getStartOfWeek() {
    const d = new Date();
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
}

function exportToExcel(data) {
    let csv = 'Agent,Rôle,Détails,Prime,Date\n';
    data.forEach(row => {
        csv += `${row.agent},${row.role},"${JSON.stringify(row.details)}",${row.prime},${row.date}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "primes_agents.csv";
    link.click();
}

async function loadAllActivities() {
    hcTableBody.innerHTML = "";
    totalTableBody.innerHTML = "";

    const startWeek = getStartOfWeek();
    const q = query(
        collection(db, "userActivities"),
        where("createdAt", ">=", Timestamp.fromDate(startWeek)),
        orderBy("createdAt")
    );

    const snapshot = await getDocs(q);
    const activities = [];
    const totals = {};
    const hcRows = [];

    snapshot.forEach(docSnap => {
        const act = docSnap.data();
        const date = act.createdAt?.toDate().toLocaleString() || "";
        activities.push({ ...act, date });

        // Construire le HTML du tableau en mémoire
        hcRows.push(`<tr>
            <td>${act.agentName || act.userId}</td>
            <td>${act.role}</td>
            <td>${JSON.stringify(act.data)}</td>
            <td>${act.prime.toFixed(2)}</td>
            <td>${date}</td>
        </tr>`);

        totals[act.agentName] = (totals[act.agentName] || 0) + act.prime;
    });

    // Injecter tout le HTML du tableau en une seule fois
    hcTableBody.innerHTML = hcRows.join('');

    // Construire et injecter le tableau des totaux
    const totalRows = Object.entries(totals).map(([agent, total]) => 
        `<tr><td>${agent}</td><td>${total.toFixed(2)}</td></tr>`
    );
    totalTableBody.innerHTML = totalRows.join('');

    // Export
    exportBtn.onclick = () => exportToExcel(activities.map(a => ({
        agent: a.agentName || a.userId,
        role: a.role,
        details: a.data,
        prime: a.prime.toFixed(2),
        date: a.date
    })));
}

onAuthStateChanged(auth, user => {
    if(!user){
        window.location.href = "login.html";
        return;
    }
    loadAllActivities();
});
</script>
