<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Résumé des Primes - HC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f7f9fc; }
h1 { text-align:center; margin-bottom:20px; }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#4D96FF; color:white; }
</style>
</head>
<body>

<h1>Résumé des Primes - HC</h1>
<p id="welcome-msg"></p>
<table id="summary-table">
  <thead>
    <tr>
      <th>Agent</th>
      <th>FTF</th>
      <th>JSD</th>
      <th>SRT</th>
      <th>AFD</th>
      <th>COM</th>
      <th>HC</th>
      <th>Total Prime</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const primeFuncs = {
    ftf: r => r*0.5,
    jsd: h => h*10,
    srt: h => h*15,
    afd: c => c*20,
    com: (p,v) => p*5 + v*10,
    hc: h => h*25
};

function renderSummary(data){
    const tbody = document.querySelector("#summary-table tbody");
    tbody.innerHTML="";
    Object.entries(data).forEach(([uid, activity])=>{
        let primes = {
            ftf: activity.ftf ? activity.ftf.reduce((sum,a)=>sum + primeFuncs.ftf(a.reward),0):0,
            jsd: activity.jsd ? activity.jsd.reduce((sum,a)=>sum + primeFuncs.jsd(a.hours),0):0,
            srt: activity.srt ? activity.srt.reduce((sum,a)=>sum + primeFuncs.srt(a.hours),0):0,
            afd: activity.afd ? activity.afd.reduce((sum,a)=>sum + primeFuncs.afd(a.convois),0):0,
            com: activity.com ? activity.com.reduce((sum,a)=>sum + primeFuncs.com(a.publications,a.videos),0):0,
            hc: activity.hc ? activity.hc.reduce((sum,a)=>sum + primeFuncs.hc(a.hours),0):0
        };
        const total = Object.values(primes).reduce((a,b)=>a+b,0);
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${uid}</td>
            <td>${primes.ftf.toFixed(2)}</td>
            <td>${primes.jsd.toFixed(2)}</td>
            <td>${primes.srt.toFixed(2)}</td>
            <td>${primes.afd.toFixed(2)}</td>
            <td>${primes.com.toFixed(2)}</td>
            <td>${primes.hc.toFixed(2)}</td>
            <td>${total.toFixed(2)}</td>`;
        tbody.appendChild(row);
    });
}

onAuthStateChanged(auth, async user=>{
    if(!user) {
        document.body.innerHTML="<h2>Accès refusé. Veuillez vous connecter.</h2>";
        return;
    }
    document.getElementById("welcome-msg").innerText=`Bienvenue ${user.email}`;

    // Vérification du rôle HC
    const roleSnap = await getDoc(doc(db,"roles",user.uid));
    const userRole = roleSnap.exists() ? roleSnap.data().role?.toLowerCase().trim() : null;

    if(userRole !== "hc"){
        document.body.innerHTML="<h2>Accès réservé aux utilisateurs HC.</h2>";
        return;
    }

    // Récupération et affichage des primes
    const snapshot = await getDocs(collection(db,"userActivities"));
    const data = {};
    snapshot.forEach(docSnap => data[docSnap.id] = docSnap.data());
    renderSummary(data);
});
</script>

</body>
</html>
