<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion des Comptes - HC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f7f9fc; }
table { width:100%; border-collapse: collapse; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
th, td { padding:10px; border:1px solid #ddd; text-align:center; }
th { background:#4D96FF; color:white; }
td[contenteditable="true"] { background:#f0f8ff; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; background:#4D96FF; color:white; }
button:hover { background:#357AE8; }
</style>
</head>
<body>

<h1>Liste des Comptes HC</h1>
<table id="users-table">
  <thead>
    <tr>
      <th>Email</th>
      <th>Nom</th>
      <th>Matricule</th>
      <th>TÃ©lÃ©phone</th>
      <th>RIB</th>
      <th>RÃ´les</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0.appspot.com",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tbody = document.querySelector("#users-table tbody");

async function fetchHCUsers() {
  const querySnapshot = await getDocs(collection(db, "users"));
  const hcUsers = [];

  for (const docSnap of querySnapshot.docs) {
    const data = docSnap.data();
    const roles = Array.isArray(data.roles) ? data.roles : [data.roles];
    if (roles.includes("HC")) {
      // RÃ©cupÃ©rer le nom depuis profiles
      const profileSnap = await getDocs(collection(db, "profiles"));
      let fullName = "";
      const profileDoc = await doc(db, "profiles", docSnap.id);
      const profileData = await profileDoc.get();
      if(profileData.exists) fullName = profileData.data().fullName || "";
      
      hcUsers.push({ id: docSnap.id, email: data.email || "", fullName, matricule: data.matricule || "", phone: data.phone || "", rib: data.rib || "", roles });
    }
  }

  renderUsers(hcUsers);
}

function renderUsers(users) {
  tbody.innerHTML = "";
  users.forEach(user => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${user.email}</td>
      <td>${user.fullName || "-"}</td>
      <td contenteditable="true" data-field="matricule">${user.matricule || "-"}</td>
      <td contenteditable="true" data-field="phone">${user.phone || "-"}</td>
      <td contenteditable="true" data-field="rib">${user.rib || "-"}</td>
      <td>${user.roles.join(", ")}</td>
      <td><button class="save-btn" data-id="${user.id}">ðŸ’¾ Sauvegarder</button></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelectorAll(".save-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const row = btn.closest("tr");
      const dataToSave = {
        matricule: row.querySelector('[data-field="matricule"]').innerText,
        phone: row.querySelector('[data-field="phone"]').innerText,
        rib: row.querySelector('[data-field="rib"]').innerText
      };
      await setDoc(doc(db, "users", id), dataToSave, { merge: true });
      alert("âœ… Modifications enregistrÃ©es !");
    });
  });
}

fetchHCUsers();
</script>

</body>
</html>
