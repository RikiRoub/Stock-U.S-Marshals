<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion des Comptes - HC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f7f9fc; }
h1 { text-align:center; margin-bottom:20px; }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#4D96FF; color:white; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
.save-btn { background:#28a745; color:white; }
</style>
</head>
<body>

<h1>Liste des Comptes Utilisateurs - HC</h1>
<p id="welcome-msg"></p>

<table id="users-table">
  <thead>
    <tr>
      <th>Email</th>
      <th>Matricule</th>
      <th>T√©l√©phone</th>
      <th>RIB</th>
      <th>R√¥les</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDArc4SUw3MO06QJwD6xzEKsuKFsfVcjsQ",
    authDomain: "gestion-stock-d63d0.firebaseapp.com",
    projectId: "gestion-stock-d63d0",
    storageBucket: "gestion-stock-d63d0",
    messagingSenderId: "865227689174",
    appId: "1:865227689174:web:213e7f6e44f183c6928d77"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function renderUsers(snapshot){
    const tbody = document.querySelector("#users-table tbody");
    tbody.innerHTML="";
    snapshot.forEach(docSnap=>{
        const user = docSnap.data();
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${user.email || "-"}</td>
            <td contenteditable="true" data-field="matricule">${user.matricule || "-"}</td>
            <td contenteditable="true" data-field="telephone">${user.telephone || "-"}</td>
            <td contenteditable="true" data-field="rib">${user.rib || "-"}</td>
            <td>${Array.isArray(user.roles) ? user.roles.join(", ") : user.roles || "-"}</td>
            <td><button class="save-btn" data-id="${docSnap.id}">üíæ Sauvegarder</button></td>
        `;
        tbody.appendChild(row);
    });

    // Ajout d‚Äôun event listener sur chaque bouton "Sauvegarder"
    document.querySelectorAll(".save-btn").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
            const uid = e.target.dataset.id;
            const row = e.target.closest("tr");
            const matricule = row.querySelector('[data-field="matricule"]').innerText.trim();
            const telephone = row.querySelector('[data-field="telephone"]').innerText.trim();
            const rib = row.querySelector('[data-field="rib"]').innerText.trim();

            await updateDoc(doc(db,"users",uid), {
                matricule, telephone, rib
            });
            alert("‚úÖ Informations mises √† jour !");
        });
    });
}

onAuthStateChanged(auth, async user=>{
    if(!user) {
        document.body.innerHTML="<h2>Acc√®s refus√©. Veuillez vous connecter.</h2>";
        return;
    }
    document.getElementById("welcome-msg").innerText=`Bienvenue ${user.email}`;

    // V√©rification r√¥le HC
    const roleSnap = await getDoc(doc(db,"users",user.uid));
    let hasHC = false;
    if (roleSnap.exists()) {
        const data = roleSnap.data();
        if (Array.isArray(data.roles)) {
            hasHC = data.roles.some(r => r.toLowerCase() === "hc");
        } else if (typeof data.roles === "string") {
            hasHC = data.roles.toLowerCase() === "hc";
        }
    }

    if (!hasHC) {
        document.body.innerHTML="<h2>Acc√®s r√©serv√© aux utilisateurs HC.</h2>";
        return;
    }

    // R√©cup√©ration des utilisateurs
    const snapshot = await getDocs(collection(db,"users"));
    renderUsers(snapshot.docs);
});
</script>

</body>
</html>
